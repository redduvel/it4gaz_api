<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT4Gaz Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="bg-dark text-white">
            <div class="sidebar-header">
                <h3>IT4Gaz</h3>
            </div>

            <ul class="list-unstyled components">
                <li class="active">
                    <a href="index.html">
                        <i class="bi bi-house-door"></i> Главная
                    </a>
                </li>
                <li>
                    <a href="#analysisSubmenu" data-bs-toggle="collapse" class="dropdown-toggle">
                        <i class="bi bi-graph-up"></i> Анализ
                    </a>
                    <ul class="collapse list-unstyled" id="analysisSubmenu">
                        <li>
                            <a href="analysis/graph.html">
                                <i class="bi bi-graph-up-arrow"></i> График
                            </a>
                        </li>
                        <li>
                            <a href="analysis/table.html">
                                <i class="bi bi-table"></i> Таблица
                            </a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="visualization.html">
                        <i class="bi bi-bar-chart"></i> Визуализация
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Page Content -->
        <div id="content">
            <!-- Top Navigation -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-dark">
                        <i class="bi bi-list"></i>
                    </button>
                    <div class="ms-auto">
                        <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="bi bi-upload"></i> Загрузить данные
                        </button>
                        <button class="btn btn-outline-dark position-relative" id="notificationBtn">
                            <i class="bi bi-bell"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                2
                            </span>
                        </button>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <div class="container-fluid py-4">
                <h2 class="mb-4">Добро пожаловать в IT4Gaz Dashboard</h2>
                
                <div class="row g-4">
                    <!-- Analysis Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-graph-up display-4 text-primary mb-3"></i>
                                <h5 class="card-title">Анализ</h5>
                                <p class="card-text">Просмотр и анализ данных</p>
                                <a href="analysis/graph.html" class="btn btn-primary">Перейти</a>
                            </div>
                        </div>
                    </div>

                    <!-- Graph Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-graph-up-arrow display-4 text-success mb-3"></i>
                                <h5 class="card-title">График</h5>
                                <p class="card-text">Визуализация данных в виде графиков</p>
                                <a href="analysis/graph.html" class="btn btn-success">Перейти</a>
                            </div>
                        </div>
                    </div>

                    <!-- Table Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-table display-4 text-warning mb-3"></i>
                                <h5 class="card-title">Таблица</h5>
                                <p class="card-text">Просмотр данных в табличном виде</p>
                                <a href="analysis/table.html" class="btn btn-warning">Перейти</a>
                            </div>
                        </div>
                    </div>

                    <!-- Visualization Card -->
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="bi bi-bar-chart display-4 text-info mb-3"></i>
                                <h5 class="card-title">Визуализация</h5>
                                <p class="card-text">Интерактивная визуализация данных</p>
                                <a href="visualization.html" class="btn btn-info">Перейти</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Загрузка данных</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="fileInput" class="form-label">Выберите файл</label>
                                <input type="file" class="form-control" id="fileInput" accept=".csv,.xlsx,.xls">
                            </div>
                            <div class="mb-3">
                                <label for="tableName" class="form-label">Название таблицы</label>
                                <input type="text" class="form-control" id="tableName" placeholder="Введите название таблицы">
                            </div>
                            <div id="analysisResult" class="alert d-none"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                        <button type="button" class="btn btn-primary" id="analyzeBtn" disabled>
                            <i class="bi bi-search"></i> Анализировать
                        </button>
                        <button type="button" class="btn btn-success" id="uploadBtn" disabled>
                            <i class="bi bi-upload"></i> Загрузить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notification Panel -->
        <div class="offcanvas offcanvas-end" tabindex="-1" id="notificationPanel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Уведомления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
            </div>
            <div class="offcanvas-body">
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Обновление данных</h6>
                            <small>10:30</small>
                        </div>
                        <p class="mb-1">Данные успешно обновлены</p>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Новое предупреждение</h6>
                            <small>09:15</small>
                        </div>
                        <p class="mb-1">Обнаружены аномалии в данных</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const analysisResult = document.getElementById('analysisResult');
            const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));

            // Enable analyze button when file is selected
            fileInput.addEventListener('change', function() {
                analyzeBtn.disabled = !this.files.length;
                uploadBtn.disabled = true;
                analysisResult.classList.add('d-none');
            });

            // Handle file analysis
            analyzeBtn.addEventListener('click', async function() {
                const file = fileInput.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('separator', ';'); // Добавляем разделитель по умолчанию

                try {
                    analyzeBtn.disabled = true;
                    analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Анализ...';

                    const response = await fetch('/api/v1/data/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    analysisResult.classList.remove('d-none', 'alert-success', 'alert-danger');
                    analysisResult.classList.add(result.status === 'success' ? 'alert-success' : 'alert-danger');
                    
                    if (result.status === 'success') {
                        analysisResult.textContent = `Файл успешно проанализирован. Найдено ${result.column_count} колонок.`;
                        uploadBtn.disabled = false;
                    } else {
                        analysisResult.textContent = result.message || 'Произошла ошибка при анализе файла';
                    }
                } catch (error) {
                    analysisResult.classList.remove('d-none', 'alert-success', 'alert-danger');
                    analysisResult.classList.add('alert-danger');
                    analysisResult.textContent = 'Произошла ошибка при анализе файла';
                } finally {
                    analyzeBtn.disabled = false;
                    analyzeBtn.innerHTML = '<i class="bi bi-search"></i> Анализировать';
                }
            });

            // Handle file upload
            uploadBtn.addEventListener('click', async function() {
                const file = fileInput.files[0];
                const tableName = document.getElementById('tableName').value.trim();
                
                if (!file) return;
                if (!tableName) {
                    analysisResult.classList.remove('d-none', 'alert-success', 'alert-danger');
                    analysisResult.classList.add('alert-danger');
                    analysisResult.textContent = 'Пожалуйста, введите название таблицы';
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('table_name', tableName);
                formData.append('create_table', 'true');

                try {
                    uploadBtn.disabled = true;
                    uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Загрузка...';

                    const response = await fetch('/api/v1/data/create_and_load', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        analysisResult.classList.remove('d-none', 'alert-success', 'alert-danger');
                        analysisResult.classList.add('alert-success');
                        analysisResult.textContent = 'Файл успешно загружен';
                        
                        // Close modal after 2 seconds
                        setTimeout(() => {
                            uploadModal.hide();
                            // Reset form
                            fileInput.value = '';
                            document.getElementById('tableName').value = '';
                            analyzeBtn.disabled = true;
                            uploadBtn.disabled = true;
                            analysisResult.classList.add('d-none');
                        }, 2000);
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    analysisResult.classList.remove('d-none', 'alert-success', 'alert-danger');
                    analysisResult.classList.add('alert-danger');
                    analysisResult.textContent = 'Произошла ошибка при загрузке файла';
                } finally {
                    uploadBtn.disabled = false;
                    uploadBtn.innerHTML = '<i class="bi bi-upload"></i> Загрузить';
                }
            });
        });
    </script>
</body>
</html> 